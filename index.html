<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>アンケート（カウンセリング用・最終版）</title>
  <meta name="color-scheme" content="light dark" />
  <!--
    このHTMLはカウンセリング用アンケートページの最終版です。
    AI口コミ生成プロンプトのガイドラインを最新指示に合わせて修正し、
    SEO語句の候補も「心理検査」を除外しました。
    このファイルはユーザーの要望に応じて編集済みです。
    Q1（通所の目的・お困りごと）セクションから「カウンセリング」の選択肢を削除しました。
  -->

  <style>
    html {
      box-sizing: border-box;
    }
    *,
    *::before,
    *::after {
      box-sizing: inherit;
    }
    body {
      overflow-x: hidden;
    }
    :root {
      --card-bg: rgba(255, 255, 255, 0.92);
      --text: #0f172a;
      --muted: #64748b;
      --shadow: 0 10px 30px rgba(0, 0, 0, 0.12);
      --radius: 18px;
      --maxw: 900px;
      --star-filled: #fbbc04;
      --star-empty: #e5e7eb;
    }
    @media (prefers-color-scheme: dark) {
      :root {
        --card-bg: rgba(17, 24, 39, 0.9);
        --text: #e2e8f0;
        --muted: #94a3b8;
      }
    }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Hiragino Kaku Gothic ProN, Segoe UI, Meiryo, Roboto, sans-serif;
      color: var(--text);
      background: linear-gradient(-45deg, #dbeafe, #e0f2fe, #f0fdfa, #fef9c3);
      background-size: 400% 400%;
      animation: bg 20s ease infinite;
      min-height: 100dvh;
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
    }
    @keyframes bg {
      0% {
        background-position: 0% 50%;
      }
      50% {
        background-position: 100% 50%;
      }
      100% {
        background-position: 0% 50%;
      }
    }
    @media (prefers-reduced-motion: reduce) {
      body {
        animation: none;
      }
    }
    .wrap {
      max-width: var(--maxw);
      margin: 0 auto;
      padding: 20px;
    }
    .card {
      background: var(--card-bg);
      backdrop-filter: blur(8px);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px;
      width: 100%;
      overflow: hidden;
    }
    form {
      display: grid;
      gap: 22px;
    }
    fieldset {
      border: none;
      padding: 0;
      margin: 0;
      min-width: 0;
    }
    legend {
      font-weight: 700;
      margin-bottom: 8px;
      font-size: 16px;
    }
    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px 12px;
    }
    .chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      border: 1px solid #d4d4d8;
      border-radius: 999px;
      background: #fff;
      box-shadow: 0 1px 0 rgba(0, 0, 0, 0.04);
      max-width: 100%;
      position: relative;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.15s ease, border-color 0.15s ease,
        box-shadow 0.15s ease, color 0.15s ease;
    }
    .chip input[type='checkbox'],
    .chip input[type='radio'] {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      appearance: none;
      opacity: 0;
      pointer-events: auto;
    }
    label.chip.active,
    label.chip:has(input:checked) {
      background: linear-gradient(135deg, #1e3a8a 0%, #1d4ed8 100%) !important;
      color: #ffffff !important;
      border-color: #1d4ed8 !important;
      box-shadow: 0 8px 14px rgba(29, 78, 216, 0.28) !important,
        0 0 0 2px rgba(59, 130, 246, 0.38) !important;
    }
    label.chip:hover {
      box-shadow: 0 10px 18px rgba(29, 78, 216, 0.3),
        0 0 0 2px rgba(59, 130, 246, 0.4);
    }
    .chip:has(input:focus-visible) {
      outline: 2px solid #60a5fa;
      outline-offset: 3px;
    }
    .chip:has(input[disabled]) {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .chip.active {
      background: #eef2ff;
      border-color: #6366f1;
      color: #0f172a;
      box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.2);
    }
    .chip.active {
      background: linear-gradient(135deg, #0b2a6d 0%, #0f3d91 100%);
      color: #eaf2ff;
      border-color: #60a5fa;
      box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.35),
        0 8px 16px rgba(2, 6, 23, 0.6);
    }
    .chip:has(input:focus-visible) {
      outline: 2px solid #38bdf8;
      outline-offset: 3px;
    }
    textarea,
    input[type='text'] {
      display: block;
      width: 100%;
      max-width: 100%;
      padding: 12px 14px;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      font-size: 15px;
      background: #fff;
    }
    textarea {
      min-height: 96px;
      resize: vertical;
    }
    ::placeholder {
      color: #9ca3af;
      opacity: 1;
    }
    .submit-bar {
      position: sticky;
      bottom: 0;
      margin-top: 4px;
    }
    .btn,
    .btn-ghost,
    .btn-go,
    #copyBtn {
      display: inline-flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
      width: 100%;
      max-width: 100%;
      padding: 14px 16px;
      font-weight: 700;
      font-size: 16px;
      border-radius: 14px;
      border: 0;
      cursor: pointer;
    }
    .btn,
    .btn-go {
      color: #fff;
      background: linear-gradient(135deg, #0f766e, #14b8a6);
      box-shadow: 0 8px 14px rgba(15, 118, 110, 0.22);
    }
    .btn-ghost,
    #copyBtn {
      background: #eef2ff;
      color: #0f172a;
      border: 1px solid #c7d2fe;
      padding: 12px 14px;
      border-radius: 12px;
    }
    .btn:active,
    .btn-go:active,
    .btn-ghost:active,
    #copyBtn:active {
      transform: translateY(1px);
    }
    .view {
      display: none;
    }
    .view.active {
      display: block;
      min-width: 0;
    }
    .result-card {
      display: grid;
      gap: 14px;
      min-width: 0;
    }
    .lead {
      margin-top: 4px;
      line-height: 1.7;
    }
    .lead .spaced {
      display: block;
      margin-top: 1em;
    }
    .actions {
      display: grid;
      gap: 10px;
      grid-template-columns: minmax(0, 1fr);
      align-items: stretch;
      min-width: 0;
    }
    .divider-arrow {
      text-align: center;
      font-size: 22px;
      opacity: 0.7;
    }
    .small {
      font-size: 12px;
      color: #64748b;
    }
    .summary {
      background: #ffffff;
      border: 1px dashed #e5e7eb;
      border-radius: 12px;
      padding: 12px;
    }
    #reviewOutput {
      font-size: 16px;
      line-height: 1.75;
      min-height: clamp(180px, 36vh, 320px);
      max-height: 60vh;
      overflow-y: auto;
      resize: none;
      border: 2px solid #94a3b8;
      border-radius: 12px;
      pointer-events: auto !important;
      resize: vertical !important;
      caret-color: #111827;
    }
    @media (prefers-color-scheme: dark) {
      #reviewOutput {
        color: #111827 !important;
        background: #ffffff !important;
        border-color: #cbd5e1 !important;
      }
    }
    .loading-overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(240, 244, 255, 0.72);
      backdrop-filter: blur(6px);
      z-index: 9999;
    }
    @media (prefers-color-scheme: dark) {
      .loading-overlay {
        background: rgba(2, 6, 23, 0.6);
      }
    }
    .loading-card {
      width: min(var(--maxw), 92vw);
      max-width: 520px;
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px;
    }
    .loading-title {
      font-weight: 700;
      margin-bottom: 10px;
      font-size: 16px;
    }
    .progress {
      height: 10px;
      background: #e5e7eb;
      border-radius: 999px;
      overflow: hidden;
    }
    .progress .bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #0ea5e9, #14b8a6);
      transition: width 0.18s ease;
    }
    .loading-sub {
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted);
      display: flex;
      justify-content: space-between;
    }
    #q5_fieldset .row {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px 10px;
    }
    #q5_fieldset .chip {
      width: 100%;
      padding: 9px 12px;
      font-size: 14px;
    }
    @media (min-width: 560px) {
      #q5_fieldset .row {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
    }
    @media (min-width: 900px) {
      #q5_fieldset .row {
        grid-template-columns: repeat(4, minmax(0, 1fr));
      }
    }
    .lead-center {
      text-align: center;
    }
    .lead-center .lead-sub {
      color: var(--muted);
    }
    .lead-center .lead-em {
      color: #0891b2;
      font-weight: 700;
    }
    .lead-center .lead-note {
      color: var(--muted);
      font-size: 12px;
    }
    .lead.lead-center {
      margin-top: 6px;
      line-height: 1.95;
    }
    #q1_other,
    #q2_other,
    #q5_other,
    textarea#q9 {
      position: static !important;
      inset: auto !important;
      width: 100% !important;
      height: auto !important;
      min-height: 96px !important;
      opacity: 1 !important;
      pointer-events: auto !important;
      padding: 12px 14px !important;
      border: 1px solid #e5e7eb !important;
      background: #fff !important;
      border-radius: 12px !important;
      box-shadow: none !important;
    }
    label.chip:has(input[type='text']),
    label.chip.active:has(input[type='text']) {
      background: transparent !important;
      border-color: transparent !important;
      box-shadow: none !important;
      padding: 0 !important;
    }
    label.chip:has(input[type='text']) input[type='text'] {
      position: static !important;
      opacity: 1 !important;
    }
    @media (prefers-color-scheme: dark) {
      html {
        color-scheme: dark;
      }
      :root {
        --star-empty: #334155;
      }
      .chip {
        background: #263241 !important;
        color: #e2e8f0 !important;
        border-color: #334155 !important;
        box-shadow: none !important;
      }
      .chip input[type='checkbox'],
      .chip input[type='radio'] {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 100%;
        appearance: none;
        opacity: 0;
        pointer-events: auto;
      }
      textarea,
      input[type='text'] {
        background: #0f172a !important;
        color: #e2e8f0 !important;
        border-color: #334155 !important;
      }
      ::placeholder {
        color: #94a3b8 !important;
      }
      .btn-ghost,
      #copyBtn {
        background: #0b1220 !important;
        color: #e2e8f0 !important;
        border-color: #334155 !important;
      }
      .summary {
        background: #0f172a !important;
        border-color: #334155 !important;
      }
      .progress {
        background: #1f2937 !important;
      }
      .small,
      .rate-text {
        color: #94a3b8 !important;
      }
      .lead-center .lead-em {
        color: #22d3ee;
      }
      .lead-center .lead-note {
        color: #94a3b8;
      }
      #reviewOutput {
        border: 2px solid #64748b !important;
        border-radius: 12px;
      }
      label.chip:has(input:checked),
      label.chip.active {
        background: linear-gradient(135deg, #0b2a6d 0%, #0f3d91 100%) !important;
        color: #eaf2ff !important;
        border-color: #60a5fa !important;
        box-shadow: 0 0 0 2px rgba(96, 165, 250, 0.35) !important,
          0 8px 16px rgba(2, 6, 23, 0.6) !important;
      }
      label.chip:has(input:focus-visible) {
        outline: 2px solid #38bdf8 !important;
        outline-offset: 3px;
      }
      textarea,
      input[type='text'] {
        color: #111827 !important;
        background: #ffffff !important;
        caret-color: #111827 !important;
        border-color: #cbd5e1 !important;
      }
      ::placeholder {
        color: #6b7280 !important;
      }
      #q9 {
        color: #111827 !important;
        background: #ffffff !important;
      }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="card">
      <section id="view-survey" class="view active" aria-label="アンケート">
      <!-- フォームや内容は省略（元の内容を保持） -->
      ...
      </section>
      <!-- レスポンス表示など -->
      ...
    </div>
  </div>

  <script>
    function computePeriodPhrase(ans) {
      switch (ans.q10) {
        case "初めて":
          return "今回は初めて利用しました。";
        case "３カ月未満":
          return "通い始めてまだ数か月です。";
        case "半年未満":
          return "通い始めて半年程度です。";
        case "１年未満":
          return "通い始めて1年弱です。";
        case "数年":
          return "数年通っています。";
        default:
          return "";
      }
    }

    function getSeoTerms(ans) {
      const CANDIDATES = ["武蔵小杉", "カウンセリング", "WAIS-Ⅳ", "TEG3"];
      const haystack = [
        ...(ans.q1 ?? []),
        ...(ans.q2 ?? []),
        ans.q3 ?? "",
        ans.q9 ?? "",
      ].join("");
      const found = CANDIDATES.filter((k) => haystack.includes(k));
      for (let i = found.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [found[i], found[j]] = [found[j], found[i]];
      }
      return found;
    }

    function getDoctorName(ans) {
      const known = ["渡辺", "笈川", "市毛", "森本"];

      // 既知の担当者名がある場合は「先生」を付けて返す
      if (known.includes(ans.q3)) return `${ans.q3}先生`;

      // 自由記載がある場合は、既に「先生」「医」などが含まれていればそのまま、それ以外は「先生」を付ける
      if (ans.q3 === "その他" && ans.q3_other && ans.q3_other.trim()) {
        const trimmed = ans.q3_other.trim();

        // 「担当医」と入力された場合は「先生」に置き換える
        if (trimmed === "担当医") {
          return "先生";
        }
        // 既に「先生」で終わっている場合はそのまま
        if (trimmed.endsWith("先生")) {
          return trimmed;
        }
        // それ以外の自由記入には「先生」を付ける
        return `${trimmed}先生`;
      }

      // 氏名が不明な場合は「先生」を用いる
      return "先生";
    }

    function buildSystemPrompt(ans) {
      const counselor = getDoctorName(ans);
      const clinic =
        typeof appConfig !== "undefined" && appConfig.clinicName
          ? appConfig.clinicName
          : "当施設";
      const periodPhrase = computePeriodPhrase(ans);
      const seoTerms = getSeoTerms(ans);
      const seoRule =
        seoTerms.length
          ? `- 次の語句は表記を変えず、不自然にならない位置に各1回程度入れる（順序は入れ替えてよい）：${seoTerms.join("、")}`
          : "";

      return `
あなたはカウンセリング施設のアンケート回答を自然な日本語の口コミ文に整えるアシスタントです。
- 事実ベースで誇張しない
- 一人称で丁寧な口調
- 1〜2段落で、全体はおよそ100〜150字前後（改行は自然に）
- 絵文字・機種依存文字は使わない
- 「セッション」という語を避け、面談の様子と表記する
- 構成は時系列（利用のきっかけ→探した経緯→選んだ理由→面談の様子→良かった点→総合コメント）
- 「WAIS-Ⅳ」や「TEG3」など検査名、また「カウンセリング」が目的として選択されている場合は、症状が続いたという表現ではなく、検査やカウンセリングを受けるという自然な表現に置き換える
- 一文目には必ず施設名「${clinic}」を含める（書き出しの文の形は自由）
- 先生の表記は：名前が不明な場合は「先生」、それ以外は先生名をそのまま用いる
- 医師関連の表現を避ける（「医師」「担当医」「担当の医師」といった表現は使わず、「先生」または氏名＋「先生」の表記とする）
${
  periodPhrase
    ? `- 通所期間は次の文面を本文に必ず一度含める：「${periodPhrase}」`
    : ""
}
${seoRule ? seoRule : ""}
- SEO語句を盛り込む際は「〜を中心に情報を探した」「〜を意識して」といった表現を使わず、自然な文脈で活用する
- 「良かった点」（q5）は不自然にならない範囲で反映する;
      `;
    }

    const appConfig = {
      clinicName: "心のクリニック武蔵小杉",
      googleReviewUrl: "https://g.pagerCZZ6G6Jhb7YZEBMreview",
      ai: {
        mode: "endpoint",
        endpoint: "https://clinic-review.onrender.com/api/review",
        headers: {},
      },
    };
    (function () {
      const isLocal = location.protocol === "file:";
      appConfig.ai.mode = isLocal ? "mock" : "endpoint";
    })();

    const $$ = (s, r = document) => Array.from(r.querySelectorAll(s));
    const sanitizeInline = (text) => {
      if (!text) return "";
      return String(text)
        .replace(/[\n\r]+/g, "、")
        .replace(/[ ]+/g, " ")
        .trim();
    };
    const getCheckedValues = (name) =>
      $$("input[name='" + name + "']:checked").map((el) => el.value);
    const listJa = (arr) =>
      !arr
        ? "—"
        : !arr.length
        ? "—"
        : arr.length === 1
        ? arr[0]
        : arr.slice(0, -1).join("、") + "、" + arr[arr.length - 1];
    const toggle = (el, show) => {
      if (el) el.style.display = show ? "" : "none";
    };
    function filterPositives(items) {
      const positives = new Set([
        "良く聞いてくれた",
        "WEB予約が便利",
        "Cashless決済が便利",
        "駅近くで便利",
        "TEG3の検査",
        "WAIS-Ⅳの検査",
        "カウンセリング",
      ]);
      return (items ?? []).filter((x) => positives.has(x));
    }

    // ここを修正： MIN=100, MAX=150 へ変更
    function enforceLength(text, ans) {
      if (text == null) return text;
      let t = String(text)
        .replace(/[ \t]+/g, " ")
        .replace(/\n{3,}/g, "\n\n")
        .trim();
      const MIN = 100;
      const MAX = 150;
      const expandMap = {
        良く聞いてくれた:
          "落ち着いて話せる雰囲気で、こちらのペースに合わせて進めてくださいました。些細な不安にも耳を傾けてくれて、納得いくまで相談できました。",
        WEB予約が便利:
          "WEB予約による手続きが簡単で、都合に合わせて利用しやすかったです。",
        Cashless決済が便利:
          "キャッシュレス決済が使用でき、会計がスムーズで手間がかかりませんでした。",
        駅近くで便利:
          "武蔵小杉駅が近いので、継続利用もしやすいと感じます。",
        TEG3の検査: "TEG3の心理検査も受けられ、状態の理解が深まりました。",
        WAIS-Ⅳの検査:
          "WAIS-Ⅳの検査を通じて自分の特性を知ることができ、有意義でした。",
        カウンセリング:
          "カウンセリングが丁寧で、安心して話をすることができました。",
      };
      const plainLen = t.replace(/\n/g, "").length;
      if (plainLen > MAX) {
        let cut = t.replace(/\n/g, "");
        if (cut.length > MAX) cut = cut.slice(0, MAX);
        const lastPeriod = cut.lastIndexOf("。");
        if (lastPeriod >= 0 && lastPeriod > MIN + 2) cut = cut.slice(0, lastPeriod + 1);
        t = cut.endsWith("。") ? cut : cut + "。";
        return t;
      }
      if (plainLen < MIN && ans) {
        const reasons = (ans.q5 ?? []).filter((x) => Object.prototype.hasOwnProperty.call(expandMap, x));
        for (const r of reasons) {
          if (t.replace(/\n/g, "").length >= MIN) break;
          const add = expandMap[r];
          if (add && !t.includes(add)) t += (t.endsWith("。") ? "" : "。") + add;
        }
        const period = computePeriodPhrase(ans);
        if (period && !t.includes(period) && t.replace(/\n/g, "").length < MIN) {
          t += (t.endsWith("。") ? "" : "。") + period;
        }
        const filler = "全体として落ち着いて利用でき、今後も安心して通えそうだと感じました。";
        if (t.replace(/\n/g, "").length < MIN && !t.includes(filler)) {
          t += (t.endsWith("。") ? "" : "。") + filler;
        }
      }
      return t;
    }

    // 以下は元のロジックのまま (generateReviewなど) ...
    // 変更箇所以外を省略しているので、元コード全体を反映する場合は適宜補完してください
  </script>

  <!-- ローディングオーバーレイ等は省略 -->
  ...
</body>
</html>
