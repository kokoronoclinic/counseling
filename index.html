<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>アンケート（カウンセリング用・最終版）</title>
  <meta name="color-scheme" content="light dark" />
  <!--
    このHTMLはカウンセリング用アンケートページの最終版です。
    AI口コミ生成プロンプトのガイドラインを最新指示に合わせて修正し、
    SEO語句の候補も「心理検査」を除外しました。

    このファイルはユーザーの要望に応じて編集済みです。
    Q1（通所の目的・お困りごと）セクションから「カウンセリング」の選択肢を削除しました。
  -->
  <style>
    html { box-sizing: border-box; }
    *, *::before, *::after { box-sizing: inherit; }
    body { overflow-x: hidden; }
    :root {
      --card-bg: rgba(255, 255, 255, 0.92);
      --text: #0f172a;
      --muted: #64748b;
      --shadow: 0 10px 30px rgba(0,0,0,.12);
      --radius: 18px;
      --maxw: 900px;
      --star-filled: #fbbc04;
      --star-empty: #e5e7eb;
    }
    @media (prefers-color-scheme: dark) {
      :root { --card-bg: rgba(17, 24, 39, 0.9); --text: #e2e8f0; --muted: #94a3b8; }
    }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, "Hiragino Kaku Gothic ProN", "Segoe UI", Meiryo, Roboto, sans-serif;
      color: var(--text);
      background: linear-gradient(-45deg, #dbeafe, #e0f2fe, #f0fdfa, #fef9c3);
      background-size: 400% 400%;
      animation: bg 20s ease infinite;
      min-height: 100dvh;
      -webkit-font-smoothing: antialiased; text-rendering: optimizeLegibility;
    }
    @keyframes bg { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
    @media (prefers-reduced-motion: reduce) { body { animation: none; } }
    .wrap { max-width: var(--maxw); margin: 0 auto; padding: 20px; }
    .card {
      background: var(--card-bg);
      backdrop-filter: blur(8px);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px;
      width: 100%;
      overflow: hidden;
    }
    form { display: grid; gap: 22px; }
    fieldset { border: none; padding: 0; margin: 0; min-width: 0; }
    legend { font-weight: 700; margin-bottom: 8px; font-size: 16px; }
    .row { display: flex; flex-wrap: wrap; gap: 10px 12px; }
    .chip {
      display: inline-flex; align-items: center; gap: 8px;
      padding: 10px 12px; border: 1px solid #d4d4d8; border-radius: 999px;
      background: #fff; box-shadow: 0 1px 0 rgba(0,0,0,.04);
      max-width: 100%;
      position: relative;
      cursor: pointer;
      user-select: none;
      transition: background-color .15s ease, border-color .15s ease, box-shadow .15s ease, color .15s ease;
    }
    .chip > input[type="checkbox"],
    .chip > input[type="radio"] {
      position: absolute;
      inset: 0;
      width: 100%; height: 100%;
      appearance: none;
      opacity: 0;
      pointer-events: auto;
    }
    label.chip.active,
    label.chip:has(> input:checked) {
      background: linear-gradient(135deg, #1e3a8a 0%, #1d4ed8 100%) !important;
      color: #ffffff !important;
      border-color: #1d4ed8 !important;
      box-shadow:
        0 8px 14px rgba(29, 78, 216, .28) !important,
        0 0 0 2px rgba(59, 130, 246, .38) !important;
    }
    label.chip:hover {
      box-shadow:
        0 10px 18px rgba(29, 78, 216, .30),
        0 0 0 2px rgba(59, 130, 246, .40);
    }
    .chip:has(> input:focus-visible) {
      outline: 2px solid #60a5fa;
      outline-offset: 3px;
    }
    .chip:has(> input[disabled]) {
      opacity: .6;
      cursor: not-allowed;
    }
    .chip.active {
      background: #eef2ff;
      border-color: #6366f1;
      color: #0f172a;
      box-shadow: 0 0 0 2px rgba(99,102,241,.20);
    }
    .chip.active {
      background: linear-gradient(135deg, #0b2a6d 0%, #0f3d91 100%);
      color: #eaf2ff;
      border-color: #60a5fa;
      box-shadow:
        0 0 0 2px rgba(96,165,250,.35),
        0 8px 16px rgba(2, 6, 23, .6);
    }
    .chip:has(> input:focus-visible) {
      outline: 2px solid #38bdf8;
      outline-offset: 3px;
    }
    textarea, input[type="text"] {
      display: block;
      width: 100%;
      max-width: 100%;
      padding: 12px 14px;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      font-size: 15px;
      background: #fff;
    }
    textarea { min-height: 96px; resize: vertical; }
    ::placeholder { color: #9ca3af; opacity: 1; }
    .submit-bar { position: sticky; bottom: 0; margin-top: 4px; }
    .btn,
    .btn-ghost,
    .btn-go,
    #copyBtn {
      display: inline-flex; justify-content: center; align-items: center; gap: 10px;
      width: 100%; max-width: 100%;
      padding: 14px 16px; font-weight: 700; font-size: 16px; border-radius: 14px; border: 0; cursor: pointer;
    }
    .btn, .btn-go {
      color: #fff;
      background: linear-gradient(135deg, #0f766e, #14b8a6);
      box-shadow: 0 8px 14px rgba(15, 118, 110, .22);
    }
    .btn-ghost, #copyBtn {
      background: #eef2ff; color: #0f172a; border: 1px solid #c7d2fe;
      padding: 12px 14px; border-radius: 12px;
    }
    .btn:active, .btn-go:active, .btn-ghost:active, #copyBtn:active { transform: translateY(1px); }
    .view { display: none; }
    .view.active { display: block; min-width: 0; }
    .result-card { display: grid; gap: 14px; min-width: 0; }
    .lead { margin-top: 4px; line-height: 1.7; }
    .lead .spaced { display:block; margin-top: 1em; }
    .actions {
      display: grid;
      gap: 10px;
      grid-template-columns: minmax(0, 1fr);
      align-items: stretch;
      min-width: 0;
    }
    .divider-arrow { text-align: center; font-size: 22px; opacity: .7; }
    .small { font-size: 12px; color: #64748b; }
    .summary { background: #ffffff; border: 1px dashed #e5e7eb; border-radius: 12px; padding: 12px; }
    #reviewOutput{
      font-size: 16px;
      line-height: 1.75;
      min-height: clamp(180px, 36vh, 320px);
      max-height: 60vh;
      overflow-y: auto;
      resize: none;
      border: 2px solid #94a3b8;
      border-radius: 12px;
      pointer-events: auto !important;
      resize: vertical !important;
      caret-color: #111827;
    }
    @media (prefers-color-scheme: dark){
      #reviewOutput{
        color: #111827 !important;
        background: #ffffff !important;
        border-color: #cbd5e1 !important;
      }
    }
    .loading-overlay {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(240, 244, 255, 0.72);
      backdrop-filter: blur(6px);
      z-index: 9999;
    }
    @media (prefers-color-scheme: dark) {
      .loading-overlay { background: rgba(2, 6, 23, 0.6); }
    }
    .loading-card {
      width: min(var(--maxw), 92vw);
      max-width: 520px;
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px;
    }
    .loading-title { font-weight: 700; margin-bottom: 10px; font-size: 16px; }
    .progress { height: 10px; background: #e5e7eb; border-radius: 999px; overflow: hidden; }
    .progress > .bar {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #0ea5e9, #14b8a6);
      transition: width .18s ease;
    }
    .loading-sub { margin-top: 10px; font-size: 12px; color: var(--muted); display: flex; justify-content: space-between; }
    #q5_fieldset .row{
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px 10px;
    }
    #q5_fieldset .chip{
      width: 100%;
      padding: 9px 12px;
      font-size: 14px;
    }
    @media (min-width: 560px){
      #q5_fieldset .row{ grid-template-columns: repeat(3, minmax(0, 1fr)); }
    }
    @media (min-width: 900px){
      #q5_fieldset .row{ grid-template-columns: repeat(4, minmax(0, 1fr)); }
    }
    .lead-center { text-align: center; }
    .lead-center .lead-sub { color: var(--muted); }
    .lead-center .lead-em { color: #0891b2; font-weight: 700; }
    .lead-center .lead-note { color: var(--muted); font-size: 12px; }
    .lead.lead-center { margin-top: 6px; line-height: 1.95; }
    #q1_other, #q2_other, #q5_other, textarea#q9 {
      position: static !important;
      inset: auto !important;
      width: 100% !important;
      height: auto !important;
      min-height: 96px !important;
      opacity: 1 !important;
      pointer-events: auto !important;
      padding: 12px 14px !important;
      border: 1px solid #e5e7eb !important;
      background: #fff !important;
      border-radius: 12px !important;
      box-shadow: none !important;
    }
    label.chip:has(> input[type="text"]),
    label.chip.active:has(> input[type="text"]) {
      background: transparent !important;
      border-color: transparent !important;
      box-shadow: none !important;
      padding: 0 !important;
    }
    label.chip:has(> input[type="text"]) > input[type="text"] {
      position: static !important;
      opacity: 1 !important;
    }
    @media (prefers-color-scheme: dark) {
      html { color-scheme: dark; }
      :root { --star-empty: #334155; }
      .chip {
        background:#263241 !important;
        color:#e2e8f0 !important;
        border-color:#334155 !important;
        box-shadow:none !important;
      }
      .chip > input[type="checkbox"],
      .chip > input[type="radio"] {
        position: absolute;
        inset: 0;
        width: 100%; height: 100%;
        appearance: none;
        opacity: 0;
        pointer-events: auto;
      }
      textarea, input[type="text"] {
        background:#0f172a !important;
        color:#e2e8f0 !important;
        border-color:#334155 !important;
      }
      ::placeholder { color:#94a3b8 !important; }
      .btn-ghost, #copyBtn {
        background:#0b1220 !important;
        color:#e2e8f0 !important;
        border-color:#334155 !important;
      }
      .summary { background:#0f172a !important; border-color:#334155 !important; }
      .progress { background:#1f2937 !important; }
      .small, .rate-text { color:#94a3b8 !important; }
      .lead-center .lead-em   { color:#22d3ee; }
      .lead-center .lead-note { color:#94a3b8; }
      #reviewOutput{
        border: 2px solid #64748b !important;
        border-radius: 12px;
      }
      label.chip:has(> input:checked),
      label.chip.active {
        background: linear-gradient(135deg, #0b2a6d 0%, #0f3d91 100%) !important;
        color: #eaf2ff !important;
        border-color: #60a5fa !important;
        box-shadow:
          0 0 0 2px rgba(96,165,250,.35) !important,
          0 8px 16px rgba(2, 6, 23, .6) !important;
      }
      label.chip:has(> input:focus-visible) {
        outline: 2px  solid #38bdf8 !important;
        outline-offset: 3px;
      }
      textarea,
      input[type="text"] {
        color: #111827 !important;
        background: #ffffff !important;
        caret-color: #111827 !important;
        border-color: #cbd5e1 !important;
      }
      ::placeholder {
        color: #6b7280 !important; }
      #q9 {
        color: #111827 !important;
        background: #ffffff !important;
      }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">

      <section id="view-survey" class="view active" aria-label="アンケート">
        <form id="surveyForm">
          <!-- Q1 -->
          <fieldset>
            <legend>1. 通所の目的・お困りごとを教えてください（複数回答可）</legend>
            <div class="row">
              <label class="chip"><input type="checkbox" name="q2" value="不眠">不眠</label>
              <label class="chip"><input type="checkbox" name="q2" value="不安">不安</label>
              <label class="chip"><input type="checkbox" name="q2" value="抑うつ">抑うつ</label>
              <label class="chip"><input type="checkbox" name="q2" value="悩み相談">悩み相談</label>
              <!-- 以下、検査やカウンセリングを目的として通所される場合の選択肢を追加 -->
              <label class="chip"><input type="checkbox" name="q2" value="WAIS-Ⅳ">WAIS-Ⅳ</label>
              <label class="chip"><input type="checkbox" name="q2" value="TEG3">TEG3</label>
              <!-- ユーザーの要望により「カウンセリング」の選択肢を削除しました -->
              <label class="chip"><input type="checkbox" name="q2" value="その他">その他</label>
            </div>
            <div class="group" id="q2_other_wrap" style="display:none; margin-top:8px;">
              <textarea id="q2_other" placeholder="その他（自由記載）"></textarea>
            </div>
          </fieldset>
          <!-- Q2 -->
          <fieldset>
            <legend>2. 当施設を選んだ経緯を教えてください（複数回答可）</legend>
            <div class="row">
              <label class="chip"><input type="checkbox" name="q1" value="武蔵小杉駅近く">武蔵小杉駅近く</label>
              <label class="chip"><input type="checkbox" name="q1" value="自宅近く">自宅近く</label>
              <label class="chip"><input type="checkbox" name="q1" value="当日予約">当日予約</label>
              <label class="chip"><input type="checkbox" name="q1" value="WEB予約">WEB予約</label>
              <label class="chip"><input type="checkbox" name="q1" value="土日開所">土日開所</label>
              <!-- WAIS-Ⅳ・TEG3・カウンセリングは「目的」の質問に移動したため削除 -->
              <label class="chip"><input type="checkbox" name="q1" value="その他">その他</label>
            </div>
            <div class="group" id="q1_other_wrap" style="display:none; margin-top:8px;">
              <textarea id="q1_other" placeholder="その他（自由記載）"></textarea>
            </div>
          </fieldset>
          <!-- Q3 -->
          <fieldset>
            <legend>3. 担当のお名前を教えてください（1つ選択／選択なし可）</legend>
            <div class="radio-list" role="radiogroup" aria-label="担当カウンセラー">
              <label class="chip"><input type="radio" name="q3" value="渡辺">渡辺</label>
              <label class="chip"><input type="radio" name="q3" value="笈川">笈川</label>
              <label class="chip"><input type="radio" name="q3" value="市毛">市毛</label>
              <label class="chip"><input type="radio" name="q3" value="森本">森本</label>
              <label class="chip"><input type="radio" name="q3" value="その他">その他</label>
            </div>
          </fieldset>
          <div class="group" id="q3_other_wrap" style="display:none; margin-top:8px;">
            <input type="text" id="q3_other" placeholder="担当者名（自由記載）" />
          </div>
          <!-- Q4 -->
          <fieldset id="q5_fieldset">
            <legend>4. 当施設をお勧めできる点を教えてください（複数回答可）</legend>
            <div class="row">
              <label class="chip"><input type="checkbox" name="q5" value="良く聞いてくれた">良く聞いてくれた</label>
              <label class="chip"><input type="checkbox" name="q5" value="WEB予約が便利">WEB予約が便利</label>
              <label class="chip"><input type="checkbox" name="q5" value="キャッシュレス決済">キャッシュレス決済</label>
              <label class="chip"><input type="checkbox" name="q5" value="武蔵小杉駅近く">武蔵小杉駅近く</label>
              <!-- 以下の選択肢を修正：検査・カウンセリングを削除し、新たに利便性に関する項目を追加 -->
              <label class="chip"><input type="checkbox" name="q5" value="待ち時間が短い">待ち時間が短い</label>
              <label class="chip"><input type="checkbox" name="q5" value="説明が分かりやすい">説明が分かりやすい</label>
              <label class="chip"><input type="checkbox" name="q5" value="会計がスムーズ">会計がスムーズ</label>
              <label class="chip"><input type="checkbox" name="q5" value="その他">その他</label>
            </div>
            <div class="group" id="q5_other_wrap" style="display:none; margin-top:8px;">
              <textarea id="q5_other" placeholder="その他（自由記載）"></textarea>
            </div>
          </fieldset>
          <!-- Q5 -->
          <fieldset id="q10_container">
            <legend>5. 通所してからどのくらい経過していますか？（1つ選択）</legend>
            <div class="radio-list" role="radiogroup" aria-label="通所期間">
              <label class="chip"><input type="radio" name="q10" value="初めて">初めて</label>
              <label class="chip"><input type="radio" name="q10" value="３カ月未満">3か月未満</label>
              <label class="chip"><input type="radio" name="q10" value="半年未満">半年未満</label>
              <label class="chip"><input type="radio" name="q10" value="１年未満">1年未満</label>
              <label class="chip"><input type="radio" name="q10" value="数年">数年</label>
            </div>
          </fieldset>
          <!-- Q6 -->
          <fieldset>
            <legend>6. その他、何かありましたらご記載ください。（自由回答）</legend>
            <!-- セッションという語を避け、面談に言い換え -->
            <textarea id="q9" placeholder="例）面談の印象や雰囲気、予約や会計の使い勝手など、自由にお書きください"></textarea>
          </fieldset>
          <div class="submit-bar">
            <button class="btn" type="submit" aria-label="送信">【送信】</button>
          </div>
        </form>
      </section>
      <section id="view-positive" class="view" aria-label="（内部ラベル）">
        <div class="result-card">
          <p class="lead lead-center">
            <strong>アンケートへのご協力、ありがとうございました。</strong><br>
            頂いたご意見はスタッフ間で共有し、今後の改善に活かします。<br><br>
            <span class="lead-sub">ご回答内容を AI で文章化しました。</span><br>
            <!-- 投稿用コピー案内の文言を修正し、連用形として表現 -->
            <span class="lead-sub">画面下のボタンからコピーして、投稿にご利用できます。</span><br>
            <span class="lead-em">口コミ投稿にご協力頂けますと幸いです。</span><br>
            <span class="lead-em">♪ スタッフの励みになります ♪</span><br>
            <!-- AI 生成文の利用に関する注記の文言を修正（編集も任意であることを明示） -->
            <span class="lead-note">※ AI 文の使用・編集は任意です。</span>
          </p>
          <textarea id="reviewOutput"></textarea>
          <div class="actions">
            <button class="btn-ghost" id="copyBtn" type="button">上記の内容をコピーする</button>
            <div class="divider-arrow" aria-hidden="true">↓</div>
            <button class="btn-go" id="openBtn" type="button">Googleの口コミ投稿ページを開く</button>
            <a id="googleLink" href="#" style="display:none" aria-hidden="true" tabindex="-1"></a>
          </div>
          <details class="summary" hidden>
            <summary>入力内容のサマリー（開く）</summary>
            <div id="answerSummary" class="small"></div>
          </details>
        </div>
      </section>
      <section id="view-thanks" class="view" aria-label="（内部ラベル）">
        <div class="result-card">
          <h2 style="margin:0; font-size:20px;">アンケートへのご協力、ありがとうございました。</h2>
          <p>いただいたご意見はスタッフ間で共有し、より良いサービス提供に活かしてまいります。</p>
          <button class="btn-ghost" type="button" id="backBtn">画面を閉じる</button>
        </div>
      </section>
    </div>
  </div>

<script>
  function computePeriodPhrase(ans) {
    switch (ans.q10) {
      case "初めて":     return "今回は初めて利用しました。";
      case "３カ月未満": return "通い始めてまだ数か月です。";
      case "半年未満":   return "通い始めて半年程度です。";
      case "１年未満":   return "通い始めて1年弱です。";
      case "数年":       return "数年通っています。";
      default:           return "";
    }
  }
  function getSeoTerms(ans) {
    const CANDIDATES = ["武蔵小杉","カウンセリング","WAIS-Ⅳ","TEG3"];
    const haystack = [
      ...(ans.q1 || []),
      ...(ans.q2 || []),
      ans.q3 || "",
      ans.q9 || "",
    ].join(" ");
    const found = CANDIDATES.filter(k => haystack.includes(k));
    for (let i = found.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [found[i], found[j]] = [found[j], found[i]];
    }
    return found;
  }
  function getDoctorName(ans){
    const known = ["渡辺","笈川","市毛","森本"];
    // 既知の担当者名がある場合は「先生」を付けて返す
    if (known.includes(ans.q3)) return `${ans.q3}先生`;
    // その他に自由記載がある場合も同様に「先生」を付ける
    if (ans.q3 === "その他" && ans.q3_other && ans.q3_other.trim()){
      return `${ans.q3_other.trim()}先生`;
    }
    // 氏名が不明な場合は「担当の先生」を用いる
    return "担当の先生";
  }
  function buildSystemPrompt(ans) {
    const counselor = getDoctorName(ans);
    const clinic = (typeof appConfig !== "undefined" && appConfig.clinicName) ? appConfig.clinicName : "当施設";
    const periodPhrase = computePeriodPhrase(ans);
    const seoTerms = getSeoTerms(ans);
    const seoRule = seoTerms.length
      ? `- 次の語句は**表記を変えず**、不自然にならない位置に各1回程度入れる（順序は入れ替えてよい）：${seoTerms.join("、")}`
      : "";
    return `あなたはカウンセリング施設のアンケート回答を自然な日本語の口コミ文に整えるアシスタントです。\n` +
      `- 事実ベースで誇張しない\n` +
      `- 一人称で丁寧な口調\n` +
      `- 1〜2段落で、全体はおよそ150字前後（改行は自然に）\n` +
      `- 絵文字・機種依存文字は使わない\n` +
      // "セッション" という語を避け、面談の様子と表記する
      `- 構成は時系列（利用のきっかけ→探した経緯→選んだ理由→面談の様子→良かった点→総合コメント）\n` +
      `- 「WAIS-Ⅳ」や「TEG3」など検査名、また「カウンセリング」が目的として選択されている場合は、症状が続いたという表現ではなく、検査やカウンセリングを受けるという自然な表現に置き換える\n` +
      `- 一文目には必ず施設名「${clinic}」を含める（書き出しの文の形は自由）\n` +
      // カウンセラーではなく先生という表現を使用する
      `- 先生の表記は：${counselor === "担当の先生" ? "氏名が不明なので「担当の先生」を用いる" : `本文中に一度は先生名「${counselor}」を明記する`} ` + `\n` +
      (periodPhrase ? `- 通所期間は次の文面を本文に必ず一度含める：「${periodPhrase}」\n` : "") +
      (seoRule ? seoRule + "\n" : "") +
      `- SEO語句を盛り込む際は「〜を中心に情報を探した」「〜を意識して」といった表現を使わず、自然な文脈で活用する\n` +
      `- 「良かった点」（q5）は不自然にならない範囲で反映する`;
  }
  const appConfig = {
    clinicName: "心のクリニック武蔵小杉",
    googleReviewUrl: "https://g.page/r/CZZ6G6Jhb7YZEBM/review",
    ai: { mode: "endpoint", endpoint: "https://clinic-review.onrender.com/api/review", headers: {} }
  };
  (() => {
    const isLocal = location.protocol === "file:";
    appConfig.ai.mode = isLocal ? "mock" : "endpoint";
  })();
  const $$ = (s, r = document) => Array.from(r.querySelectorAll(s));
  const sanitizeInline = (text) => { if (!text) return ""; return String(text).replace(/[\n\r]+/g, "、").replace(/[<>]/g, "").trim(); };
  const getCheckedValues = (name) => $$('input[name="'+name+'"]:checked').map(el=>el.value);
  const listJa = (arr) => !arr || !arr.length ? "" : (arr.length === 1 ? arr[0] : arr.slice(0,-1).join("、") + "、" + arr[arr.length-1]);
  const toggle = (el, show) => { if (el) el.style.display = show ? "" : "none"; };
  function filterPositives(items) {
    const positives = new Set([
      "良く聞いてくれた","WEB予約が便利","キャッシュレス決済","武蔵小杉駅近く",
      "TEG3の検査","WAIS-Ⅳの検査","カウンセリング"
    ]);
    return (items||[]).filter(x => positives.has(x));
  }
  function enforceLength(text, ans) {
    if (text == null) return text;
    let t = String(text)
      .replace(/[ \t]+/g, " ")
      .replace(/\n{3,}/g, "\n\n")
      .trim();
    const MIN = 180;
    const MAX = 220;
    const expandMap = {
      "良く聞いてくれた": "落ち着いて話せる雰囲気で、こちらのペースに合わせて進めてくださいました。些細な不安にも耳を傾けてくれて、納得いくまで相談できました。",
      "WEB予約が便利": "WEB予約による手続きが簡単で、都合に合わせて利用しやすかったです。",
      "キャッシュレス決済": "キャッシュレス決済が使用でき、会計がスムーズで手間がかかりませんでした。",
      "武蔵小杉駅近く": "武蔵小杉駅が近いので、継続利用もしやすいと感じます。",
      "TEG3の検査": "TEG3の心理検査も受けられ、状態の理解が深まりました。",
      "WAIS-Ⅳの検査": "WAIS-Ⅳの検査を通じて自分の特性を知ることができ、有意義でした。",
      "カウンセリング": "カウンセリングが丁寧で、安心して話をすることができました。"
    };
    const plainLen = t.replace(/\n/g, "").length;
    if (plainLen > MAX) {
      let cut = t.replace(/\n/g, "");
      if (cut.length > MAX) cut = cut.slice(0, MAX);
      const lastPeriod = cut.lastIndexOf("。");
      if (lastPeriod >= 0 && lastPeriod > MIN / 2) cut = cut.slice(0, lastPeriod + 1);
      t = cut.endsWith("。") ? cut : (cut + "。");
      return t;
    }
    if (plainLen < MIN && ans) {
      const reasons = (ans.q5 || []).filter(x => Object.prototype.hasOwnProperty.call(expandMap, x));
      for (const r of reasons) {
        if (t.replace(/\n/g, "").length >= MIN) break;
        const add = expandMap[r];
        if (add && !t.includes(add)) t += (t.endsWith("。") ? "" : "。") + add;
      }
      const period = computePeriodPhrase(ans);
      if (period && !t.includes(period) && t.replace(/\n/g, "").length < MIN) {
        t += (t.endsWith("。") ? "" : "。") + period;
      }
      const filler = "全体として落ち着いて利用でき、今後も安心して通えそうだと感じました。";
      if (t.replace(/\n/g, "").length < MIN && !t.includes(filler)) {
        t += (t.endsWith("。") ? "" : "。") + filler;
      }
    }
    return t;
  }
  function generateReviewLocally(ans) {
    const deptList = ["困った事があり", "悩み相談", "心理相談"];
    const dept = deptList[Math.floor(Math.random() * deptList.length)];
    // 動機の文章を柔軟に生成する。症状が続いた場合は「〜が続き」、検査やカウンセリングが目的の場合はそれぞれ「〜の検査を受けるため」「カウンセリングを受けるため」と表現する
    let motive = "心身の不調が続いたため";
    if (ans.q2 && ans.q2.length) {
      const symptomsList = ["不眠","不安","抑うつ","悩み相談"];
      const testsList = ["WAIS-Ⅳ","TEG3"];
      const counselList = ["カウンセリング"];
      const symptoms = ans.q2.filter(x => symptomsList.includes(x));
      const tests = ans.q2.filter(x => testsList.includes(x));
      const counsel = ans.q2.filter(x => counselList.includes(x));
      const parts = [];
      if (symptoms.length) parts.push(`「${listJa(symptoms)}」が続き`);
      if (tests.length) parts.push(`${listJa(tests)}の検査を受けるため`);
      if (counsel.length) parts.push(`カウンセリングを受けるため`);
      if (parts.length) {
        motive = parts.join("、");
      }
    }
    const chooseMap = {
      "武蔵小杉駅近く": "武蔵小杉駅から近かったこと",
      "自宅近く": "自宅から近かったこと",
      "当日予約": "当日予約ができたこと",
      "WEB予約": "WEB予約が便利だったこと",
      "土日開所": "土日も開所していること",
      "WAIS-Ⅳ": "WAIS-Ⅳの検査が受けられたこと",
      "TEG3": "TEG3の検査を受けられたこと",
      "カウンセリング": "カウンセリングを受けるため"
    };
    const chosen = (ans.q1 || []).map(v => chooseMap[v] || v);
    let chooseText = "";
    if (chosen.length) {
      chooseText += `${listJa(chosen)}が決め手となり、`;
    }
    const doctor = getDoctorName(ans);
    const good = filterPositives(ans.q5);
    const goodLine = good.length ? `特に「${listJa(good.slice(0,3))}」と感じました。` : "";
    const extra = sanitizeInline(ans.q9);
    const closing = "予約から会計までの流れもスムーズで、安心して利用できました。";
    const endingsRaw = [
      "こちらを利用しました","コチラを利用しました",
      "心のクリニックを利用しました","心のクリニック武蔵小杉を利用しました"
    ];
    const endings = endingsRaw.map(s => s.replace(/[。．.]+$/u, ""));
    const ending = endings[Math.floor(Math.random() * endings.length)];
    const periodPhrase = computePeriodPhrase(ans);
    const seoTerms = getSeoTerms(ans);
    // SEO 用語を自然に取り入れる。特定の語に注目したり意識したりしたという表現は使わない
    const seoPhrase = "";
    const lines = [];
    let first = `${motive}、${seoPhrase}${dept}を探し、${chooseText}${ending}。`;
    if (periodPhrase) first += " " + periodPhrase;
    lines.push(first);
    // 「セッション」という語を使わず、直接先生の様子を記述する
    lines.push(`${doctor}が話をよく聞いてくださり、状態や今後の方針も分かりやすく説明してくださいました。`);
    if (goodLine) lines.push(goodLine);
    lines.push(extra || closing);
    lines.push("同じようなお悩みの方にも勧めたいと思います。");
    return lines.join("\n");
  }
  async function generateReviewWithEndpoint(ans) {
    try {
      const res = await fetch(appConfig.ai.endpoint, {
        method: "POST",
        headers: { "Content-Type": "application/json", ...appConfig.ai.headers },
        body: JSON.stringify({ answers: ans, systemPrompt: buildSystemPrompt(ans) })
      });
      if (!res.ok) throw new Error("bad status " + res.status);
      const data = await res.json();
      if (data && data.review) return data.review;
      return generateReviewLocally(ans);
    } catch (e) {
      console.warn("AIエンドポイント呼出エラー", e);
      return generateReviewLocally(ans);
    }
  }
  async function generateReview(ans) {
    if (appConfig.ai.mode === "endpoint" && appConfig.ai.endpoint) return generateReviewWithEndpoint(ans);
    return generateReviewLocally(ans);
  }
  function collectAnswers(form) {
    const q1 = getCheckedValues("q1");
    if (q1.includes("その他")) {
      const t = sanitizeInline(document.getElementById("q1_other").value);
      if (t) q1[q1.indexOf("その他")] = t; else q1.splice(q1.indexOf("その他"),1);
    }
    const q2 = getCheckedValues("q2");
    if (q2.includes("その他")) {
      const t = sanitizeInline(document.getElementById("q2_other").value);
      if (t) q2[q2.indexOf("その他")] = t; else q2.splice(q2.indexOf("その他"),1);
    }
    let q3 = document.querySelector("input[name='q3']:checked")?.value || "";
    if (q3 === "その他") {
      const t = sanitizeInline(document.getElementById("q3_other").value);
      q3 = t || "";
    }
    const q5 = getCheckedValues("q5");
    if (q5.includes("その他")) {
      const t = sanitizeInline(document.getElementById("q5_other").value);
      if (t) q5[q5.indexOf("その他")] = t; else q5.splice(q5.indexOf("その他"),1);
    }
    return {
      q1, q2, q3,
      q5,
      q10: document.querySelector("input[name='q10']:checked")?.value || "",
      q9: document.getElementById("q9").value.trim(),
      q3_other: document.getElementById("q3_other")?.value.trim() || ""
    };
  }
  function renderSummary(ans) {
    const lines = [];
    lines.push(`通所の目的/お困りごと: ${ans.q2?.length ? listJa(ans.q2) : "—"}`);
    lines.push(`選んだ経緯: ${ans.q1?.length ? listJa(ans.q1) : "—"}`);
    lines.push(`担当者: ${ans.q3 || "—"}`);
    lines.push(`通所期間(Q5): ${ans.q10 || "—"}`);
    lines.push(`お勧めできる点(Q4): ${ans.q5?.length ? listJa(ans.q5) : "—"}`);
    if (ans.q9) lines.push(`自由記述(Q6): ${ans.q9}`);
    document.getElementById("answerSummary").textContent = lines.join("\n");
  }
  function showView(id) {
    document.querySelectorAll(".view").forEach(v => v.classList.remove("active"));
    document.getElementById(id).classList.add("active");
    try { history.pushState({view: id}, "", "#"+id); } catch {}
    window.scrollTo({ top: 0, behavior: "smooth" });
  }
  function updateGoogleLink() {
    const a = document.getElementById("googleLink");
    if (a) a.href = appConfig.googleReviewUrl || "https://maps.google.com/";
  }
  function autosizeTextarea(ta) {
    if (!ta) return;
    const max = Math.round(window.innerHeight * 0.60);
    const min = Math.round(window.innerHeight * 0.36);
    ta.style.height = "auto";
    const next = Math.max(min, Math.min(max, ta.scrollHeight));
    ta.style.height = next + "px";
  }
  window.addEventListener("DOMContentLoaded", () => {
    window.addEventListener("resize", () => autosizeTextarea(document.getElementById("reviewOutput")));
    const bindOther = (name, wrapId) => {
      document.querySelectorAll(`input[name='${name}']`).forEach(el => {
        el.addEventListener("change", () => {
          const checked = getCheckedValues(name).includes("その他");
          toggle(document.getElementById(wrapId), checked);
        });
      });
    };
    const bindRadioOther = (name, wrapId) => {
      const wrap = document.getElementById(wrapId);
      const update = () => {
        const v = document.querySelector(`input[name='${name}']:checked`)?.value || "";
        if (wrap) wrap.style.display = (v === "その他") ? "" : "none";
      };
      document.querySelectorAll(`input[name='${name}']`).forEach(el => {
        el.addEventListener("change", update);
      });
      update();
    };
    bindOther("q1","q1_other_wrap");
    bindOther("q2","q2_other_wrap");
    bindOther("q5","q5_other_wrap");
    bindRadioOther("q3","q3_other_wrap");
    (function () {
      const syncGroup = (name) => {
        document.querySelectorAll(`input[name="${name}"]`).forEach(x => {
          const lab = x.closest('label.chip');
          if (lab) lab.classList.toggle('active', x.checked);
        });
      };
      document.querySelectorAll('label.chip > input').forEach(inp => {
        const lab = inp.closest('label.chip');
        if (lab) lab.classList.toggle('active', inp.checked);
        inp.addEventListener('change', () => {
          if (inp.type === 'radio') {
            syncGroup(inp.name);
          } else {
            if (lab) lab.classList.toggle('active', inp.checked);
          }
        });
      });
    })();
    document.getElementById("surveyForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      const ans = collectAnswers(e.currentTarget);
      renderSummary(ans);
      try {
        let review = await (async () => {
          if (appConfig.ai && appConfig.ai.mode === "endpoint" && appConfig.ai.endpoint) {
            try {
              const res = await fetch(appConfig.ai.endpoint, {
                method: "POST", headers: { "Content-Type": "application/json", ...(appConfig.ai.headers||{}) },
                body: JSON.stringify({ answers: ans, systemPrompt: buildSystemPrompt(ans) })
              });
              if (res.ok) {
                const data = await res.json();
                if (data && data.review) return data.review;
              }
            } catch {}
          }
          return generateReviewLocally(ans);
        })();
        review = enforceLength(review, ans);
        const out = document.getElementById("reviewOutput");
        out.value = review;
        out.readOnly = false;
        out.removeAttribute("readonly");
        out.disabled = false;
        out.style.pointerEvents = "auto";
        out.style.caretColor = "#111827";
        if (typeof hideLoading === "function") hideLoading();
        updateGoogleLink();
        showView("view-positive");
        if (typeof autosizeTextarea === "function") autosizeTextarea(out);
        out.focus();
      } catch (err) {
        console.error(err);
        showView("view-thanks");
      }
    });
    document.getElementById("openBtn").addEventListener("click", () => {
      const url = appConfig.googleReviewUrl || "https://maps.google.com/";
      const w = window.open(url, "_blank", "noopener");
      if (!w) location.href = url;
    });
    document.getElementById("copyBtn").addEventListener("click", async () => {
      try {
        await navigator.clipboard.writeText(document.getElementById("reviewOutput").value);
        alert("投稿案をコピーしました。Googleの画面で貼り付けてご利用ください。");
      } catch {
        const ta = document.getElementById("reviewOutput");
        ta.select(); document.execCommand("copy");
        alert("投稿案をコピーしました。Googleの画面で貼り付けてご利用ください。");
      }
    });
    document.getElementById("backBtn")?.addEventListener("click", () => {
      try { window.open("", "_self"); } catch {}
      try { window.close(); } catch {}
      setTimeout(() => { try { location.href = "about:blank"; } catch {} }, 80);
    });
    if (location.hash === "#view-positive") { showView("view-positive"); autosizeTextarea(document.getElementById("reviewOutput")); }
    if (location.hash === "#view-thanks") showView("view-thanks");
  });
</script>
<div id="loadingOverlay" class="loading-overlay" role="dialog" aria-modal="true" aria-labelledby="loadingTitle" aria-live="polite">
  <div class="loading-card">
    <div id="loadingTitle" class="loading-title">アンケート結果を送信中…</div>
    <div class="progress" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0">
      <div id="loadingBar" class="bar"></div>
    </div>
    <div class="loading-sub">
      <span id="loadingNote">通常10秒ほどかかります。このままお待ちください。</span>
      <span id="loadingPct">0%</span>
    </div>
  </div>
</div>
<script>
  (function() {
    let timer = null;
    let drift = null;
    let progress = 0;
    const EXPECTED_MS    = 11111;
    const HOLD_AT        = 90;
    const DRIFT_MAX      = 97;
    const DRIFT_STEP     = 1;
    const DRIFT_INTERVAL = 900;
    const overlay = () => document.getElementById("loadingOverlay");
    const bar     = () => document.getElementById("loadingBar");
    const pct     = () => document.getElementById("loadingPct");
    const progEl  = () => document.querySelector(".progress");
    function updateAria(now){ try { const p = progEl(); if (p) p.setAttribute("aria-valuenow", String(now)); } catch {} }
    function setProgress(v){ progress = Math.max(0, Math.min(100, Math.round(v))); const b = bar(); if (!b) return; b.style.width = progress + "%"; pct().textContent = progress + "%"; updateAria(progress); }
    window.showLoading = function() {
      const ov = overlay(); if (!ov) return;
      try { if (timer) clearInterval(timer); } catch {}
      try { if (drift) clearInterval(drift); } catch {}
      timer = drift = null;
      setProgress(0);
      ov.style.display = "flex";
      document.body.setAttribute("aria-busy", "true");
      document.body.style.pointerEvents = "none";
      document.body.style.touchAction = "none";
      const start = performance.now();
      timer = setInterval(() => {
        const elapsedMs = performance.now() - start;
        const ideal = (elapsedMs / EXPECTED_MS) * 100;
        const target = Math.min(HOLD_AT, Math.floor(ideal));
        if (target > progress) setProgress(target);
        if (progress >= HOLD_AT && !drift) {
          clearInterval(timer); timer = null;
          drift = setInterval(() => {
            if (progress < DRIFT_MAX) setProgress(progress + DRIFT_STEP);
          }, DRIFT_INTERVAL);
        }
      }, 120);
    };
    window.hideLoading = function() {
      const ov = overlay(); if (!ov) return;
      try { if (timer) clearInterval(timer); } catch {}
      try { if (drift) clearInterval(drift); } catch {}
      timer = drift = null;
      setProgress(100);
      setTimeout(() => {
        ov.style.display = "none";
        document.body.removeAttribute("aria-busy");
        document.body.style.pointerEvents = "";
        document.body.style.touchAction = "";
        setProgress(0);
      }, 220);
    };
    const _fetch = window.fetch.bind(window);
    window.fetch = async function(input, init) {
      const url = (typeof input === "string") ? input : (input && input.url) || "";
      const method = (init && (init.method || init?.options?.method) || "GET").toUpperCase();
      const isTarget = (typeof appConfig !== "undefined")
        && appConfig?.ai?.mode === "endpoint"
        && !!appConfig?.ai?.endpoint
        && url === appConfig.ai.endpoint
        && method === "POST";
      if (!isTarget) return _fetch(input, init);
      try {
        window.showLoading();
        const res = await _fetch(input, init);
        return res;
      } finally {
        window.hideLoading();
      }
    };
  })();
</script>
</body>
</html>
